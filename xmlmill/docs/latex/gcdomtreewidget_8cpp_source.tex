\hypertarget{gcdomtreewidget_8cpp_source}{\section{gcdomtreewidget.\-cpp}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Copyright (c) 2012 - 2013 by William Hallatt.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * This file forms part of "XML Mill".}
00004 \textcolor{comment}{ *}
00005 \textcolor{comment}{ * The official website for this project is <http://www.goblincoding.com> and,}
00006 \textcolor{comment}{ * although not compulsory, it would be appreciated if all works of whatever}
00007 \textcolor{comment}{ * nature using this source code (in whole or in part) include a reference to}
00008 \textcolor{comment}{ * this site.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ * Should you wish to contact me for whatever reason, please do so via:}
00011 \textcolor{comment}{ *}
00012 \textcolor{comment}{ *                 <http://www.goblincoding.com/contact>}
00013 \textcolor{comment}{ *}
00014 \textcolor{comment}{ * This program is free software: you can redistribute it and/or modify it
       under}
00015 \textcolor{comment}{ * the terms of the GNU General Public License as published by the Free
       Software}
00016 \textcolor{comment}{ * Foundation, either version 3 of the License, or (at your option) any later}
00017 \textcolor{comment}{ * version.}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ * This program is distributed in the hope that it will be useful, but WITHOUT}
00020 \textcolor{comment}{ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
       FITNESS}
00021 \textcolor{comment}{ * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
       details.}
00022 \textcolor{comment}{ *}
00023 \textcolor{comment}{ * You should have received a copy of the GNU General Public License along with}
00024 \textcolor{comment}{ * this program (GNUGPL.txt).  If not, see}
00025 \textcolor{comment}{ *}
00026 \textcolor{comment}{ *                    <http://www.gnu.org/licenses/>}
00027 \textcolor{comment}{ */}
00028 
00029 \textcolor{preprocessor}{#include "gcdomtreewidget.h"}
00030 \textcolor{preprocessor}{#include "gctreewidgetitem.h"}
00031 \textcolor{preprocessor}{#include "db/gcdatabaseinterface.h"}
00032 \textcolor{preprocessor}{#include "utils/gcmessagespace.h"}
00033 \textcolor{preprocessor}{#include "utils/gcglobalspace.h"}
00034 
00035 \textcolor{preprocessor}{#include <QApplication>}
00036 \textcolor{preprocessor}{#include <QDomDocument>}
00037 \textcolor{preprocessor}{#include <QAction>}
00038 \textcolor{preprocessor}{#include <QMouseEvent>}
00039 \textcolor{preprocessor}{#include <QInputDialog>}
00040 \textcolor{preprocessor}{#include <QXmlInputSource>}
00041 
00042 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00043 
\hypertarget{gcdomtreewidget_8cpp_source_l00044}{}\hyperlink{class_g_c_dom_tree_widget_a915a336d44b042d8a134abef8805bed4}{00044} \hyperlink{class_g_c_dom_tree_widget_a915a336d44b042d8a134abef8805bed4}{GCDomTreeWidget::GCDomTreeWidget}( QWidget *parent ) :
00045   QTreeWidget           ( parent ),
00046   m\_activeItem          ( NULL ),
00047   m\_domDoc              ( new QDomDocument ),
00048   m\_commentNode         (),
00049   m\_isEmpty             ( true ),
00050   m\_busyIterating       ( false ),
00051   m\_itemBeingManipulated( false ),
00052   m\_items               (),
00053   m\_comments            ()
00054 \{
00055   setFont( QFont( \hyperlink{namespace_g_c_global_space_a9d7158c8a1dfcc867d85ee6b9c5c4810}{GCGlobalSpace::FONT}, \hyperlink{namespace_g_c_global_space_ab9fa2f10bab070a4f59b7e3ef9166c86}{GCGlobalSpace::FONTSIZE} ) );
00056   setSelectionMode( QAbstractItemView::SingleSelection );
00057   setDragDropMode( QAbstractItemView::InternalMove );
00058 
00059   QAction *rename = \textcolor{keyword}{new} QAction( \textcolor{stringliteral}{"Rename element"}, \textcolor{keyword}{this} );
00060   addAction( rename );
00061   connect( rename, SIGNAL( triggered() ), \textcolor{keyword}{this}, SLOT( renameItem() ) );
00062 
00063   QAction *\textcolor{keyword}{remove} = \textcolor{keyword}{new} QAction( \textcolor{stringliteral}{"Remove element"}, \textcolor{keyword}{this} );
00064   addAction( \textcolor{keyword}{remove} );
00065   connect( \textcolor{keyword}{remove}, SIGNAL( triggered() ), \textcolor{keyword}{this}, SLOT( removeItem() ) );
00066 
00067   QAction *stepUp = \textcolor{keyword}{new} QAction( \textcolor{stringliteral}{"Move up one level"}, \textcolor{keyword}{this} );
00068   addAction( stepUp );
00069   connect( stepUp, SIGNAL( triggered() ), \textcolor{keyword}{this}, SLOT( stepUp() ) );
00070 
00071   QAction *stepDown = \textcolor{keyword}{new} QAction( \textcolor{stringliteral}{"Move down one level"}, \textcolor{keyword}{this} );
00072   addAction( stepDown );
00073   connect( stepDown, SIGNAL( triggered() ), \textcolor{keyword}{this}, SLOT( stepDown() ) );
00074 
00075   setContextMenuPolicy( Qt::ActionsContextMenu );
00076 
00077   connect( \textcolor{keyword}{this}, SIGNAL( currentItemChanged( QTreeWidgetItem*,QTreeWidgetItem* 
      ) ), \textcolor{keyword}{this}, SLOT( currentGcItemChanged( QTreeWidgetItem*,QTreeWidgetItem* ) ) );
00078   connect( \textcolor{keyword}{this}, SIGNAL( itemClicked( QTreeWidgetItem*,\textcolor{keywordtype}{int} ) ), \textcolor{keyword}{this}, SLOT( 
      emitGcCurrentItemSelected( QTreeWidgetItem*,\textcolor{keywordtype}{int} ) ) );
00079   connect( \textcolor{keyword}{this}, SIGNAL( itemActivated( QTreeWidgetItem*, \textcolor{keywordtype}{int} ) ), \textcolor{keyword}{this}, SLOT( 
      emitGcCurrentItemSelected( QTreeWidgetItem*, \textcolor{keywordtype}{int} ) ) );
00080   connect( \textcolor{keyword}{this}, SIGNAL( itemChanged( QTreeWidgetItem*, \textcolor{keywordtype}{int} ) ), \textcolor{keyword}{this}, SLOT( 
      emitGcCurrentItemChanged( QTreeWidgetItem*, \textcolor{keywordtype}{int} ) ) );
00081 \}
00082 
00083 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00084 
\hypertarget{gcdomtreewidget_8cpp_source_l00085}{}\hyperlink{class_g_c_dom_tree_widget_aca9ba75d3798606da3f4e86c2a4b7113}{00085} \hyperlink{class_g_c_dom_tree_widget_aca9ba75d3798606da3f4e86c2a4b7113}{GCDomTreeWidget::~GCDomTreeWidget}()
00086 \{
00087   \textcolor{keyword}{delete} m\_domDoc;
00088 \}
00089 
00090 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00091 
\hypertarget{gcdomtreewidget_8cpp_source_l00092}{}\hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{00092} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{GCDomTreeWidget::gcCurrentItem}()\textcolor{keyword}{ const}
00093 \textcolor{keyword}{}\{
00094   \textcolor{keywordflow}{return} \textcolor{keyword}{dynamic\_cast<} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \textcolor{keyword}{>}( currentItem() );
00095 \}
00096 
00097 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00098 
\hypertarget{gcdomtreewidget_8cpp_source_l00099}{}\hyperlink{class_g_c_dom_tree_widget_a25d3fcc908e06b83eba4f7d1c0e0df89}{00099} QDomNode \hyperlink{class_g_c_dom_tree_widget_a25d3fcc908e06b83eba4f7d1c0e0df89}{GCDomTreeWidget::cloneDocument}()\textcolor{keyword}{ const}
00100 \textcolor{keyword}{}\{
00101   \textcolor{keywordflow}{return} m\_domDoc->documentElement().cloneNode();
00102 \}
00103 
00104 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00105 
\hypertarget{gcdomtreewidget_8cpp_source_l00106}{}\hyperlink{class_g_c_dom_tree_widget_a6cd086334f363b2d0038c815e54c2b69}{00106} QString \hyperlink{class_g_c_dom_tree_widget_a6cd086334f363b2d0038c815e54c2b69}{GCDomTreeWidget::toString}()\textcolor{keyword}{ const}
00107 \textcolor{keyword}{}\{
00108   \textcolor{keywordflow}{return} m\_domDoc->toString( 2 );
00109 \}
00110 
00111 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00112 
\hypertarget{gcdomtreewidget_8cpp_source_l00113}{}\hyperlink{class_g_c_dom_tree_widget_af70ce22ef830a0a546262ff8566cd731}{00113} QString \hyperlink{class_g_c_dom_tree_widget_af70ce22ef830a0a546262ff8566cd731}{GCDomTreeWidget::rootName}()\textcolor{keyword}{ const}
00114 \textcolor{keyword}{}\{
00115   \textcolor{keywordflow}{return} m\_domDoc->documentElement().tagName();
00116 \}
00117 
00118 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00119 
\hypertarget{gcdomtreewidget_8cpp_source_l00120}{}\hyperlink{class_g_c_dom_tree_widget_aa633c35eca5e015becede2518e031042}{00120} QString \hyperlink{class_g_c_dom_tree_widget_aa633c35eca5e015becede2518e031042}{GCDomTreeWidget::activeCommentValue}()\textcolor{keyword}{ const}
00121 \textcolor{keyword}{}\{
00122   \textcolor{keywordflow}{if}( !m\_commentNode.isNull() )
00123   \{
00124     \textcolor{comment}{/* Check if the comment is an actual comment or if it's valid XML that's
       been}
00125 \textcolor{comment}{      commented out. */}
00126     QDomDocument doc;
00127 
00128     \textcolor{keywordflow}{if}( !doc.setContent( m\_commentNode.nodeValue() ) )
00129     \{
00130       \textcolor{keywordflow}{return} m\_commentNode.nodeValue();
00131     \}
00132   \}
00133 
00134   \textcolor{keywordflow}{return} QString();
00135 \}
00136 
00137 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00138 
\hypertarget{gcdomtreewidget_8cpp_source_l00139}{}\hyperlink{class_g_c_dom_tree_widget_a29bd5591054036ef5d6073a606716df3}{00139} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a29bd5591054036ef5d6073a606716df3}{GCDomTreeWidget::setActiveCommentValue}( \textcolor{keyword}{const} QString &value )
00140 \{
00141   \textcolor{comment}{/* Check if we're editing an existing comment, or if we should add a new one.
       */}
00142   \textcolor{keywordflow}{if}( !m\_commentNode.isNull() )
00143   \{
00144     \textcolor{keywordflow}{if}( !value.isEmpty() )
00145     \{
00146       m\_commentNode.setNodeValue( value );
00147     \}
00148     \textcolor{keywordflow}{else}
00149     \{
00150       m\_comments.removeAll( m\_commentNode );
00151       m\_commentNode.parentNode().removeChild( m\_commentNode );
00152     \}
00153   \}
00154   \textcolor{keywordflow}{else}
00155   \{
00156     \textcolor{keywordflow}{if}( m\_activeItem &&
00157         !value.isEmpty() )
00158     \{
00159       QDomComment comment = m\_domDoc->createComment( value );
00160       m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().parentNode().insertBefore( comment, m\_activeItem
      ->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00161       m\_comments.append( comment );
00162       emitGcCurrentItemChanged( m\_activeItem, 0 );
00163     \}
00164   \}
00165 
00166   emitGcCurrentItemChanged( m\_activeItem, 0 );
00167 \}
00168 
00169 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00170 
\hypertarget{gcdomtreewidget_8cpp_source_l00171}{}\hyperlink{class_g_c_dom_tree_widget_ad26a2880721b62182091ead365799d57}{00171} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_ad26a2880721b62182091ead365799d57}{GCDomTreeWidget::getIncludedTreeWidgetItems}( QList< GCTreeWidgetItem* > &
      includedItems )\textcolor{keyword}{ const}
00172 \textcolor{keyword}{}\{
00173   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00174   \{
00175     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* localItem = m\_items.at( i );
00176 
00177     \textcolor{keywordflow}{if}( !localItem->\hyperlink{class_g_c_tree_widget_item_a9ea36ae7110324b227abea2036063b96}{elementExcluded}() )
00178     \{
00179       includedItems.append( localItem );
00180     \}
00181   \}
00182 \}
00183 
00184 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00185 
\hypertarget{gcdomtreewidget_8cpp_source_l00186}{}\hyperlink{class_g_c_dom_tree_widget_a913ceee0af8eefd3ec41115b64008b55}{00186} \textcolor{keyword}{const} QList< GCTreeWidgetItem* > &\hyperlink{class_g_c_dom_tree_widget_a913ceee0af8eefd3ec41115b64008b55}{GCDomTreeWidget::allTreeWidgetItems}()\textcolor{keyword}{ const}
00187 \textcolor{keyword}{}\{
00188   \textcolor{keywordflow}{return} m\_items;
00189 \}
00190 
00191 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00192 
\hypertarget{gcdomtreewidget_8cpp_source_l00193}{}\hyperlink{class_g_c_dom_tree_widget_a6da326993346229db9ba34fc13d7265e}{00193} \textcolor{keywordtype}{int} \hyperlink{class_g_c_dom_tree_widget_a6da326993346229db9ba34fc13d7265e}{GCDomTreeWidget::findItemPositionAmongDuplicates}( \textcolor{keyword}{const} QString &nodeText, \textcolor{keywordtype}{
      int} itemIndex )\textcolor{keyword}{ const}
00194 \textcolor{keyword}{}\{
00195   QList< int > indices;
00196 
00197   \textcolor{keywordflow}{if}( !m\_isEmpty )
00198   \{
00199     \textcolor{comment}{/* If there are multiple nodes with the same element name (more likely than
       not), check which}
00200 \textcolor{comment}{    of these nodes are exact duplicates with regards to attributes, values,
       etc. */}
00201     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00202     \{
00203       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *treeItem = m\_items.at( i );
00204 
00205       \textcolor{keywordflow}{if}( treeItem->\hyperlink{class_g_c_tree_widget_item_acbd4573d56cc5c6d9bd58c461b797115}{toString}() == nodeText )
00206       \{
00207         indices.append( treeItem->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() );
00208       \}
00209     \}
00210   \}
00211 
00212   \textcolor{comment}{/* Now that we have a list of all the indices matching identical nodes
       (indices are a rough}
00213 \textcolor{comment}{    indication of an element's position in the DOM and closely matches the
       "line numbers" of the}
00214 \textcolor{comment}{    items in the tree widget), we can determine the position of the selected
       DOM element relative}
00215 \textcolor{comment}{    to its doppelgangers and highlight its text representation in the text edit
       area. */}
00216   qSort( indices.begin(), indices.end() );
00217 
00218   \textcolor{keywordflow}{return} indices.indexOf( itemIndex );
00219 \}
00220 
00221 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00222 
\hypertarget{gcdomtreewidget_8cpp_source_l00223}{}\hyperlink{class_g_c_dom_tree_widget_a7bcd409950b7e72202426ac0c42c9476}{00223} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_a7bcd409950b7e72202426ac0c42c9476}{GCDomTreeWidget::setContent}( \textcolor{keyword}{const} QString &text, QString *errorMsg, \textcolor{keywordtype}{int} *
      errorLine, \textcolor{keywordtype}{int} *errorColumn )
00224 \{
00225   \hyperlink{class_g_c_dom_tree_widget_a3716c84a2a4fadc653cfac157caa215d}{clearAndReset}();
00226 
00227   QXmlInputSource source;
00228   source.setData( text );
00229   QXmlSimpleReader reader;
00230 
00231   \textcolor{keywordflow}{if}( !m\_domDoc->setContent( &source, &reader, errorMsg, errorLine, errorColumn
       ) )
00232   \{
00233     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00234   \}
00235 
00236   \hyperlink{class_g_c_dom_tree_widget_a0ac81800aa6d507dd17cbffa6814a632}{rebuildTreeWidget}();
00237   \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00238 \}
00239 
00240 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00241 
\hypertarget{gcdomtreewidget_8cpp_source_l00242}{}\hyperlink{class_g_c_dom_tree_widget_a98fe9b2e23ec44757fc4bcc6be7270c0}{00242} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_a98fe9b2e23ec44757fc4bcc6be7270c0}{GCDomTreeWidget::isEmpty}()\textcolor{keyword}{ const}
00243 \textcolor{keyword}{}\{
00244   \textcolor{keywordflow}{return} m\_isEmpty;
00245 \}
00246 
00247 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00248 
\hypertarget{gcdomtreewidget_8cpp_source_l00249}{}\hyperlink{class_g_c_dom_tree_widget_a928f82ae2f670600f10cbde52e9188fc}{00249} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_a928f82ae2f670600f10cbde52e9188fc}{GCDomTreeWidget::isCurrentItemRoot}()\textcolor{keyword}{ const}
00250 \textcolor{keyword}{}\{
00251   \textcolor{keywordflow}{if}( \hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{gcCurrentItem}() )
00252   \{
00253     \textcolor{keywordflow}{return} ( \hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{gcCurrentItem}()->element() == m\_domDoc->documentElement() );
00254   \}
00255 
00256   \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00257 \}
00258 
00259 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00260 
\hypertarget{gcdomtreewidget_8cpp_source_l00261}{}\hyperlink{class_g_c_dom_tree_widget_a7bcb145540df569caeca3119cfebc23c}{00261} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_a7bcb145540df569caeca3119cfebc23c}{GCDomTreeWidget::matchesRootName}( \textcolor{keyword}{const} QString &elementName )\textcolor{keyword}{ const}
00262 \textcolor{keyword}{}\{
00263   \textcolor{keywordflow}{return} ( elementName == m\_domDoc->documentElement().tagName() );
00264 \}
00265 
00266 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00267 
\hypertarget{gcdomtreewidget_8cpp_source_l00268}{}\hyperlink{class_g_c_dom_tree_widget_a123f18a1174ae99e567f6a2335ce1824}{00268} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_a123f18a1174ae99e567f6a2335ce1824}{GCDomTreeWidget::isDocumentCompatible}()\textcolor{keyword}{ const}
00269 \textcolor{keyword}{}\{
00270   \textcolor{keywordflow}{return} \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_ae16d516cbefe58ccf9ef0e8ece4a394f}{isDocumentCompatible}( m\_domDoc );
00271 \}
00272 
00273 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00274 
\hypertarget{gcdomtreewidget_8cpp_source_l00275}{}\hyperlink{class_g_c_dom_tree_widget_ac8a71d6111a3615a5a7eecea457a3a34}{00275} \textcolor{keywordtype}{bool} \hyperlink{class_g_c_dom_tree_widget_ac8a71d6111a3615a5a7eecea457a3a34}{GCDomTreeWidget::isBatchProcessSuccess}()\textcolor{keyword}{ const}
00276 \textcolor{keyword}{}\{
00277   \textcolor{keywordflow}{return} \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_a2c20ff88464664aef988c9c0417e19be}{batchProcessDomDocument}( m\_domDoc );
00278 \}
00279 
00280 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00281 
\hypertarget{gcdomtreewidget_8cpp_source_l00282}{}\hyperlink{class_g_c_dom_tree_widget_a1ec3ed3851e25adf1fac93fb42a4a8a7}{00282} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a1ec3ed3851e25adf1fac93fb42a4a8a7}{GCDomTreeWidget::updateItemNames}( \textcolor{keyword}{const} QString &oldName, \textcolor{keyword}{const} QString &
      newName )
00283 \{
00284   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00285   \{
00286     \textcolor{keywordflow}{if}( m\_items.at( i )->name() == oldName )
00287     \{
00288       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* item = \textcolor{keyword}{const\_cast<} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \textcolor{keyword}{>}( m\_items.at( i )
       );
00289       item->\hyperlink{class_g_c_tree_widget_item_a831acd54bf1060e3ec45a8e46439385a}{rename}( newName );
00290     \}
00291   \}
00292 \}
00293 
00294 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00295 
\hypertarget{gcdomtreewidget_8cpp_source_l00296}{}\hyperlink{class_g_c_dom_tree_widget_a0ac81800aa6d507dd17cbffa6814a632}{00296} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a0ac81800aa6d507dd17cbffa6814a632}{GCDomTreeWidget::rebuildTreeWidget}()
00297 \{
00298   clear();    \textcolor{comment}{// ONLY whack the tree widget items.}
00299   m\_items.clear();
00300 
00301   \textcolor{comment}{/* Set the document root as the first item in the tree. */}
00302   \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item = \textcolor{keyword}{new} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}( m\_domDoc->documentElement(), 
      m\_items.size() );
00303   invisibleRootItem()->addChild( item );  \textcolor{comment}{// takes ownership}
00304   m\_items.append( item );
00305   m\_isEmpty = \textcolor{keyword}{false};
00306 
00307   processNextElement( item, item->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().firstChildElement() );
00308 
00309   m\_comments.clear();
00310   populateCommentList( m\_domDoc->documentElement() );
00311 
00312   emitGcCurrentItemSelected( item, 0 );
00313 \}
00314 
00315 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00316 
\hypertarget{gcdomtreewidget_8cpp_source_l00317}{}\hyperlink{class_g_c_dom_tree_widget_afdf29124d6e6cc6061f5e9978c6a7f81}{00317} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_afdf29124d6e6cc6061f5e9978c6a7f81}{GCDomTreeWidget::appendSnippet}( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parentItem, QDomElement 
      childElement )
00318 \{
00319   parentItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().appendChild( childElement );
00320   processNextElement( parentItem, childElement );
00321   populateCommentList( childElement );
00322   updateIndices();
00323   emitGcCurrentItemSelected( currentItem(), 0 );
00324 \}
00325 
00326 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00327 
\hypertarget{gcdomtreewidget_8cpp_source_l00328}{}\hyperlink{class_g_c_dom_tree_widget_a0badfb9fc7250c5186fb9575019c335f}{00328} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a0badfb9fc7250c5186fb9575019c335f}{GCDomTreeWidget::replaceItemsWithComment}( \textcolor{keyword}{const} QList< int > &indices, \textcolor{keyword}{
      const} QString &comment )
00329 \{  
00330   QList< GCTreeWidgetItem* > itemsToDelete;
00331   \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *commentParentItem = NULL;
00332 
00333   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00334   \{
00335     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item = m\_items.at( i );
00336 
00337     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} j = 0; j < indices.size(); ++j )
00338     \{
00339       \textcolor{keywordflow}{if}( item->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() == indices.at( j ) )
00340       \{
00341         \textcolor{comment}{/* This works because the indices are always sorted from small to big,
       i.e.}
00342 \textcolor{comment}{          the item corresponding to the lowest index in indices will be the
       furthest up}
00343 \textcolor{comment}{          the node hierarchy. */}
00344         \textcolor{keywordflow}{if}( j == 0 && item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}() )
00345         \{
00346           commentParentItem = item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00347         \}
00348 
00349         \textcolor{comment}{/* Remove the element from the DOM first. */}
00350         QDomNode parentNode = item->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().parentNode();
00351         parentNode.removeChild( item->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00352 
00353         \textcolor{comment}{/* Now whack it. */}
00354         \textcolor{keywordflow}{if}( item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}() )
00355         \{
00356           \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parentItem = item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00357           parentItem->removeChild( item );
00358         \}
00359         \textcolor{keywordflow}{else}
00360         \{
00361           invisibleRootItem()->removeChild( item );
00362         \}
00363 
00364         \textcolor{comment}{/* Removing an item from another's child list does not delete it. */}
00365         itemsToDelete.append( item );
00366       \}
00367     \}
00368   \}
00369 
00370   \textcolor{comment}{/* Delete the items here so that we may be sure that they are actually
       removed}
00371 \textcolor{comment}{    from the items list as well (deleting items in the loop above resulted in
       parent}
00372 \textcolor{comment}{    items deleting all their children, but obviously not updating the items
       list in}
00373 \textcolor{comment}{    the process). */}
00374   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < itemsToDelete.size(); ++ i )
00375   \{
00376     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item = itemsToDelete.at( i );
00377     removeFromList( item );
00378     \textcolor{keyword}{delete} item;
00379     item = NULL;
00380   \}
00381 
00382   \textcolor{comment}{/* Create a comment node with the combined text of all the item nodes that
       were removed}
00383 \textcolor{comment}{    and insert it in the correct position in the DOM document. */}
00384   QDomComment newComment = m\_domDoc->createComment( comment );
00385 
00386   \textcolor{keywordflow}{if}( commentParentItem )
00387   \{
00388     commentParentItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().appendChild( newComment );
00389   \}
00390   \textcolor{keywordflow}{else}
00391   \{
00392     m\_domDoc->appendChild( newComment );
00393   \}
00394 
00395   m\_comments.append( newComment );
00396   m\_isEmpty = m\_items.isEmpty();
00397   updateIndices();
00398 \}
00399 
00400 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00401 
00402 \textcolor{keywordtype}{void} GCDomTreeWidget::processNextElement( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parentItem, 
      QDomElement element )
00403 \{
00404   \textcolor{keywordflow}{if}( parentItem )
00405   \{
00406     \textcolor{keywordflow}{while}( !element.isNull() )
00407     \{
00408       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item = \textcolor{keyword}{new} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}( element, m\_items.size() );
00409       parentItem->addChild( item );  \textcolor{comment}{// takes ownership}
00410       m\_items.append( item );
00411 
00412       processNextElement( item, element.firstChildElement() );
00413       element = element.nextSiblingElement();
00414     \}
00415 
00416     qApp->processEvents( QEventLoop::ExcludeUserInputEvents );
00417   \}
00418 \}
00419 
00420 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00421 
\hypertarget{gcdomtreewidget_8cpp_source_l00422}{}\hyperlink{class_g_c_dom_tree_widget_a06ee56d0aa9348302dbb8d3f4e5bab44}{00422} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a06ee56d0aa9348302dbb8d3f4e5bab44}{GCDomTreeWidget::populateFromDatabase}( \textcolor{keyword}{const} QString &baseElementName )
00423 \{
00424   \hyperlink{class_g_c_dom_tree_widget_a3716c84a2a4fadc653cfac157caa215d}{clearAndReset}();
00425 
00426   \textcolor{keywordflow}{if}( baseElementName.isEmpty() )
00427   \{
00428     \textcolor{comment}{/* It is possible that there may be multiple document types saved to this
       profile. */}
00429     \textcolor{keywordflow}{foreach}( QString element, \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_ac5c57277f9476ab74cfe13fbcee52f15}{knownRootElements}
      () )
00430     \{
00431       m\_isEmpty = \textcolor{keyword}{true};   \textcolor{comment}{// forces the new item to be added to the invisible
       root}
00432       \hyperlink{class_g_c_dom_tree_widget_adbbe1eeb6dc9a2d6c84a7133106a7f77}{addItem}( element );
00433       processNextElementFromDatabase( element );
00434     \}
00435   \}
00436   \textcolor{keywordflow}{else}
00437   \{
00438     \hyperlink{class_g_c_dom_tree_widget_adbbe1eeb6dc9a2d6c84a7133106a7f77}{addItem}( baseElementName );
00439     processNextElementFromDatabase( baseElementName );
00440   \}
00441 
00442   expandAll();
00443   emitGcCurrentItemSelected( currentItem(), 0 );
00444 \}
00445 
00446 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00447 
00448 \textcolor{keywordtype}{void} GCDomTreeWidget::processNextElementFromDatabase( \textcolor{keyword}{const} QString &element )
00449 \{
00450   QStringList children = \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_aab5126783bc3acc7c718c8ffd8af62bc}{children}( element );
00451 
00452   \textcolor{keywordflow}{foreach}( QString child, children )
00453   \{
00454     \hyperlink{class_g_c_dom_tree_widget_adbbe1eeb6dc9a2d6c84a7133106a7f77}{addItem}( child );
00455 
00456     \textcolor{comment}{/* Since it isn't illegal to have elements with children of the same name,
       we cannot}
00457 \textcolor{comment}{      block it in the DB, however, if we DO have elements with children of the
       same name,}
00458 \textcolor{comment}{      this recursive call enters an infinite loop, so we need to make sure that
       doesn't}
00459 \textcolor{comment}{      happen. */}
00460     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *newItem = \hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{gcCurrentItem}();
00461 
00462     \textcolor{keywordflow}{if}( !parentTreeAlreadyContainsElement( newItem, child ) )
00463     \{
00464       processNextElementFromDatabase( child );
00465     \}
00466     \textcolor{keywordflow}{else}
00467     \{
00468       setCurrentItem( m\_activeItem->parent() );  \textcolor{comment}{// required to enforce sibling
       relationships}
00469     \}
00470   \}
00471 
00472   setCurrentItem( m\_activeItem->parent() );  \textcolor{comment}{// required to enforce sibling
       relationships}
00473 \}
00474 
00475 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00476 
00477 \textcolor{keywordtype}{bool} GCDomTreeWidget::parentTreeAlreadyContainsElement( \textcolor{keyword}{const} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}*
       item, \textcolor{keyword}{const} QString &element )
00478 \{
00479   \textcolor{keywordflow}{while}( item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}() )
00480   \{
00481     \textcolor{keywordflow}{if}( item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}()->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}() == element )
00482     \{
00483       \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00484     \}
00485 
00486     item = item->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00487     parentTreeAlreadyContainsElement( item, element );
00488   \}
00489 
00490   \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00491 \}
00492 
00493 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00494 
\hypertarget{gcdomtreewidget_8cpp_source_l00495}{}\hyperlink{class_g_c_dom_tree_widget_adbbe1eeb6dc9a2d6c84a7133106a7f77}{00495} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_adbbe1eeb6dc9a2d6c84a7133106a7f77}{GCDomTreeWidget::addItem}( \textcolor{keyword}{const} QString &element, \textcolor{keywordtype}{bool} toParent )
00496 \{
00497   \textcolor{keywordflow}{if}( m\_activeItem )
00498   \{
00499     \textcolor{keywordflow}{if}( toParent )
00500     \{
00501       \hyperlink{class_g_c_dom_tree_widget_a5e4117a9b47ac0bd520d32fc54d5f1ed}{insertItem}( element, m\_activeItem->parent()->indexOfChild( m\_activeItem )
      , toParent );
00502     \}
00503     \textcolor{keywordflow}{else}
00504     \{
00505       \hyperlink{class_g_c_dom_tree_widget_a5e4117a9b47ac0bd520d32fc54d5f1ed}{insertItem}( element, m\_activeItem->childCount() - 1, toParent );
00506     \}
00507   \}
00508   \textcolor{keywordflow}{else}
00509   \{
00510     \hyperlink{class_g_c_dom_tree_widget_a5e4117a9b47ac0bd520d32fc54d5f1ed}{insertItem}( element, 0, toParent );
00511   \}
00512 \}
00513 
00514 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00515 
\hypertarget{gcdomtreewidget_8cpp_source_l00516}{}\hyperlink{class_g_c_dom_tree_widget_a5e4117a9b47ac0bd520d32fc54d5f1ed}{00516} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a5e4117a9b47ac0bd520d32fc54d5f1ed}{GCDomTreeWidget::insertItem}( \textcolor{keyword}{const} QString &elementName, \textcolor{keywordtype}{int} index, \textcolor{keywordtype}{bool} 
      toParent )
00517 \{
00518   QDomElement element = m\_domDoc->createElement( elementName );
00519 
00520   \textcolor{comment}{/* Create all the possible attributes for the element here, they can be
       changed}
00521 \textcolor{comment}{    later on. */}
00522   QStringList attributeNames = \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_afb1e49e08f98ca453f9ac66340a35642}{attributes}( 
      elementName );
00523 
00524   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < attributeNames.count(); ++i )
00525   \{
00526     element.setAttribute( attributeNames.at( i ), \textcolor{stringliteral}{""} );
00527   \}
00528 
00529   \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item = \textcolor{keyword}{new} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}( element, m\_items.size() );
00530   m\_items.append( item );
00531 
00532   \textcolor{keywordflow}{if}( m\_isEmpty )
00533   \{
00534     invisibleRootItem()->addChild( item );  \textcolor{comment}{// takes ownership}
00535     m\_domDoc->appendChild( element );
00536     m\_isEmpty = \textcolor{keyword}{false};
00537   \}
00538   \textcolor{keywordflow}{else}
00539   \{
00540     \textcolor{keywordflow}{if}( !toParent )
00541     \{
00542       m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a197806cd712ae04b129acd1699674df5}{insertGcChild}( index, item );
00543     \}
00544     \textcolor{keywordflow}{else}
00545     \{
00546       m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}()->\hyperlink{class_g_c_tree_widget_item_a197806cd712ae04b129acd1699674df5}{insertGcChild}( index, item );
00547     \}
00548   \}
00549 
00550   \textcolor{comment}{/* I will have to rethink this approach if it turns out that it is too
       expensive to}
00551 \textcolor{comment}{    iterate through the tree on each and every addition...for now, this is the
       easiest}
00552 \textcolor{comment}{    solution, even if not the best. */}
00553   updateIndices();
00554 
00555   setCurrentItem( item );
00556 \}
00557 
00558 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00559 
\hypertarget{gcdomtreewidget_8cpp_source_l00560}{}\hyperlink{class_g_c_dom_tree_widget_ab9178aca10757ba7b7cef489171fb725}{00560} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_ab9178aca10757ba7b7cef489171fb725}{GCDomTreeWidget::setCurrentItemWithIndexMatching}( \textcolor{keywordtype}{int} index )
00561 \{
00562   index = ( index < 0 ) ? 0 : index;
00563 
00564   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00565   \{
00566     \textcolor{keywordflow}{if}( m\_items.at( i )->index() == index )
00567     \{
00568       emitGcCurrentItemSelected( m\_items.at( i ), 0, false );
00569       \textcolor{keywordflow}{break};
00570     \}
00571   \}
00572 \}
00573 
00574 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00575 
\hypertarget{gcdomtreewidget_8cpp_source_l00576}{}\hyperlink{class_g_c_dom_tree_widget_ae61a0ae85b5d250c49ebc8cfc6c24d09}{00576} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_ae61a0ae85b5d250c49ebc8cfc6c24d09}{GCDomTreeWidget::setAllCheckStates}( Qt::CheckState state )
00577 \{
00578   m\_busyIterating = \textcolor{keyword}{true};
00579 
00580   QTreeWidgetItemIterator iterator( \textcolor{keyword}{this} );
00581 
00582   \textcolor{keywordflow}{while}( *iterator )
00583   \{
00584     ( *iterator )->setCheckState( 0, state );
00585     ++iterator;
00586   \}
00587 
00588   m\_busyIterating = \textcolor{keyword}{false};
00589 \}
00590 
00591 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00592 
\hypertarget{gcdomtreewidget_8cpp_source_l00593}{}\hyperlink{class_g_c_dom_tree_widget_a821fc62f1e29b67b3f6b00cd50de3bc8}{00593} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a821fc62f1e29b67b3f6b00cd50de3bc8}{GCDomTreeWidget::setShowTreeItemsVerbose}( \textcolor{keywordtype}{bool} verbose )
00594 \{
00595   m\_busyIterating = \textcolor{keyword}{true};
00596 
00597   QTreeWidgetItemIterator iterator( \textcolor{keyword}{this} );
00598 
00599   \textcolor{keywordflow}{while}( *iterator )
00600   \{
00601     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* treeItem = \textcolor{keyword}{dynamic\_cast<} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \textcolor{keyword}{>}( *iterator )
      ;
00602     treeItem->\hyperlink{class_g_c_tree_widget_item_a557b0034fd98a444a7173d76a6320f4c}{setVerbose}( verbose );
00603     ++iterator;
00604   \}
00605 
00606   m\_busyIterating = \textcolor{keyword}{false};
00607 \}
00608 
00609 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00610 
00611 \textcolor{keywordtype}{void} GCDomTreeWidget::updateIndices()
00612 \{
00613   m\_busyIterating = \textcolor{keyword}{true};
00614 
00615   QTreeWidgetItemIterator iterator( \textcolor{keyword}{this} );
00616   \textcolor{keywordtype}{int} index = 0;
00617 
00618   \textcolor{keywordflow}{while}( *iterator )
00619   \{
00620     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* treeItem = \textcolor{keyword}{dynamic\_cast<} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \textcolor{keyword}{>}( *iterator )
      ;
00621     treeItem->\hyperlink{class_g_c_tree_widget_item_af1f6be4d3badc00db1f92de2e7deb71f}{setIndex}( index );
00622     ++index;
00623     ++iterator;
00624   \}
00625 
00626   m\_busyIterating = \textcolor{keyword}{false};
00627 \}
00628 
00629 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00630 
00631 \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *GCDomTreeWidget::gcItemFromNode( QDomNode element )
00632 \{
00633   \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parentItem = NULL;
00634 
00635   \textcolor{keywordflow}{if}( !element.isNull() )
00636   \{
00637     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00638     \{
00639       \textcolor{keywordflow}{if}( m\_items.at( i )->element() == element )
00640       \{
00641         parentItem = m\_items.at( i );
00642         \textcolor{keywordflow}{break};
00643       \}
00644     \}
00645   \}
00646 
00647   \textcolor{keywordflow}{return} parentItem;
00648 \}
00649 
00650 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00651 
00652 \textcolor{keywordtype}{void} GCDomTreeWidget::removeFromList( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *item )
00653 \{
00654   \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < item->childCount(); ++i )
00655   \{
00656     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *childItem = item->\hyperlink{class_g_c_tree_widget_item_af44c0d2c5eaa1c5bb3a6a1aace3e8c78}{gcChild}( i );
00657     removeFromList( childItem );
00658   \}
00659 
00660   m\_items.removeAll( item );
00661 \}
00662 
00663 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00664 
00665 \textcolor{keywordtype}{void} GCDomTreeWidget::populateCommentList( QDomNode node )
00666 \{
00667   QDomNode childNode = node.firstChild();
00668 
00669   \textcolor{keywordflow}{while}( !childNode.isNull() )
00670   \{
00671     \textcolor{keywordflow}{if}( childNode.isComment() )
00672     \{
00673       m\_comments.append( childNode.toComment() );
00674     \}
00675 
00676     populateCommentList( childNode );
00677     childNode = childNode.nextSibling();
00678   \}
00679 \}
00680 
00681 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00682 
\hypertarget{gcdomtreewidget_8cpp_source_l00683}{}\hyperlink{class_g_c_dom_tree_widget_ac4ccf569a0c538e3c1c72e887f78f5b6}{00683} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_ac4ccf569a0c538e3c1c72e887f78f5b6}{GCDomTreeWidget::dropEvent}( QDropEvent *event )
00684 \{
00685   m\_itemBeingManipulated = \textcolor{keyword}{true};
00686 
00687   \hyperlink{class_g_c_dom_tree_widget_ac4ccf569a0c538e3c1c72e887f78f5b6}{QTreeWidget::dropEvent}( event );
00688   DropIndicatorPosition indicatorPos = dropIndicatorPosition();
00689 
00690   \textcolor{keywordflow}{if}( m\_activeItem )
00691   \{
00692     \textcolor{keywordtype}{bool} moveComment = \textcolor{keyword}{false};
00693 
00694     \textcolor{keywordflow}{if}( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().previousSibling().isComment() )
00695     \{
00696       m\_commentNode = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().previousSibling().toComment();
00697       moveComment = \textcolor{keyword}{true};
00698     \}
00699 
00700     QDomElement previousParent = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().parentNode().toElement
      ();
00701     previousParent.removeChild( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00702 
00703     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parent = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00704 
00705     \textcolor{keywordflow}{if}( parent )
00706     \{
00707       \textcolor{keywordflow}{if}( indicatorPos == QAbstractItemView::OnItem )
00708       \{
00709         parent->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().appendChild( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00710       \}
00711       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( indicatorPos == QAbstractItemView::AboveItem ||
00712                indicatorPos == QAbstractItemView::BelowItem )
00713       \{
00714         \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *sibling = NULL;
00715         \textcolor{keywordtype}{int} pos = parent->indexOfChild( m\_activeItem );
00716 
00717         \textcolor{keywordflow}{if}( pos > 0 )
00718         \{
00719           sibling = parent->\hyperlink{class_g_c_tree_widget_item_af44c0d2c5eaa1c5bb3a6a1aace3e8c78}{gcChild}( pos - 1 );
00720 
00721           \textcolor{keywordflow}{if}( sibling )
00722           \{
00723             parent->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().insertAfter( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}(), sibling->
      \hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00724           \}
00725         \}
00726         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( pos == 0 )
00727         \{
00728           sibling = parent->\hyperlink{class_g_c_tree_widget_item_af44c0d2c5eaa1c5bb3a6a1aace3e8c78}{gcChild}( pos + 1 );
00729 
00730           \textcolor{keywordflow}{if}( sibling )
00731           \{
00732             parent->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().insertBefore( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}(), sibling->
      \hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00733           \}
00734         \}
00735         \textcolor{keywordflow}{else}
00736         \{
00737           parent->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().appendChild( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00738         \}
00739       \}
00740 
00741       \textcolor{comment}{/* Move the associated comment (if any). */}
00742       \textcolor{keywordflow}{if}( moveComment )
00743       \{
00744         m\_commentNode.parentNode().removeChild( m\_commentNode );
00745         m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().parentNode().insertBefore( m\_commentNode, 
      m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00746       \}
00747 
00748       \textcolor{comment}{/* Update the database to reflect the re-parenting. */}
00749       \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_a91a60134bfb21a3f49d826340bebb852}{updateElementChildren}( parent->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}(), 
      QStringList( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}() ) );
00750     \}
00751 
00752     expandItem( parent );
00753   \}
00754 
00755   updateIndices();
00756   emitGcCurrentItemChanged( m\_activeItem, 0 );
00757   m\_itemBeingManipulated = \textcolor{keyword}{false};
00758 \}
00759 
00760 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00761 
\hypertarget{gcdomtreewidget_8cpp_source_l00762}{}\hyperlink{class_g_c_dom_tree_widget_ae79022f5265210c71c2a80eb662e3a81}{00762} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_ae79022f5265210c71c2a80eb662e3a81}{GCDomTreeWidget::keyPressEvent}( QKeyEvent *event )
00763 \{
00764   \textcolor{keywordflow}{if}( event->key() == Qt::Key\_Delete )
00765   \{
00766     removeItem();
00767   \}
00768   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( event->key() == Qt::Key\_Up ||
00769            \textcolor{keyword}{event}->key() == Qt::Key\_Down )
00770   \{
00771     \hyperlink{class_g_c_dom_tree_widget_ae79022f5265210c71c2a80eb662e3a81}{QTreeWidget::keyPressEvent}( event );
00772     emitGcCurrentItemSelected( m\_activeItem, 0 );
00773   \}
00774   \textcolor{keywordflow}{else}
00775   \{
00776     \hyperlink{class_g_c_dom_tree_widget_ae79022f5265210c71c2a80eb662e3a81}{QTreeWidget::keyPressEvent}( event );
00777   \}
00778 \}
00779 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00780 
00781 \textcolor{keywordtype}{void} GCDomTreeWidget::currentGcItemChanged( QTreeWidgetItem *current, 
      QTreeWidgetItem *previous )
00782 \{
00783   Q\_UNUSED( previous );
00784 
00785   \textcolor{keywordflow}{if}( !m\_itemBeingManipulated )
00786   \{
00787     m\_activeItem = \textcolor{keyword}{dynamic\_cast<} \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* \textcolor{keyword}{>}( current );
00788   \}
00789 \}
00790 
00791 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00792 
00793 \textcolor{keywordtype}{void} GCDomTreeWidget::emitGcCurrentItemSelected( QTreeWidgetItem *item, \textcolor{keywordtype}{int} 
      column, \textcolor{keywordtype}{bool} highlightElement )
00794 \{
00795   \textcolor{keywordflow}{if}( !m\_busyIterating )
00796   \{
00797     setCurrentItem( item, column );
00798 
00799     \textcolor{keywordflow}{if}( m\_activeItem )
00800     \{
00801       \textcolor{comment}{/* Returns NULL object if not a comment. */}
00802       m\_commentNode = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().previousSibling().toComment();
00803     \}
00804 
00805     emit \hyperlink{class_g_c_dom_tree_widget_aa4aaa06b56ebf5500fd41253144bd6fd}{gcCurrentItemSelected}( m\_activeItem, column, highlightElement );
00806   \}
00807 \}
00808 
00809 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00810 
00811 \textcolor{keywordtype}{void} GCDomTreeWidget::emitGcCurrentItemChanged( QTreeWidgetItem *item, \textcolor{keywordtype}{int} 
      column )
00812 \{
00813   \textcolor{keywordflow}{if}( !m\_busyIterating )
00814   \{
00815     setCurrentItem( item, column );
00816 
00817     \textcolor{keywordflow}{if}( m\_activeItem )
00818     \{
00819       \textcolor{comment}{/* Returns NULL object if not a comment. */}
00820       m\_commentNode = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().previousSibling().toComment();
00821     \}
00822 
00823     emit \hyperlink{class_g_c_dom_tree_widget_a20238112d91ad7a05e9a762ce2a51589}{gcCurrentItemChanged}( m\_activeItem, column );
00824   \}
00825 \}
00826 
00827 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00828 
00829 \textcolor{keywordtype}{void} GCDomTreeWidget::renameItem()
00830 \{
00831   QString newName = QInputDialog::getText( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Change element name"}, \textcolor{stringliteral}{"Enter
       the element's new name:"} );
00832 
00833   \textcolor{keywordflow}{if}( !newName.isEmpty() && m\_activeItem )
00834   \{
00835     QString oldName = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}();
00836     m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a831acd54bf1060e3ec45a8e46439385a}{rename}( newName );
00837     \hyperlink{class_g_c_dom_tree_widget_a1ec3ed3851e25adf1fac93fb42a4a8a7}{updateItemNames}( oldName, newName );
00838 
00839     \textcolor{comment}{/* The name change may introduce a new element too so we can safely call
       "addElement" below as}
00840 \textcolor{comment}{       it doesn't do anything if the element already exists in the database,
       yet it will obviously}
00841 \textcolor{comment}{       add the element if it doesn't.  In the latter case, the children  and
       attributes associated with}
00842 \textcolor{comment}{       the old name will be assigned to the new element in the process. */}
00843     QStringList attributes = \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_afb1e49e08f98ca453f9ac66340a35642}{attributes}( 
      oldName );
00844     QStringList children = \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_aab5126783bc3acc7c718c8ffd8af62bc}{children}( oldName )
      ;
00845 
00846     \textcolor{keywordflow}{if}( !\hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->addElement( newName, children, 
      attributes ) )
00847     \{
00848       \hyperlink{namespace_g_c_message_space_ab118b3a133686167617eb955029fd44e}{GCMessageSpace::showErrorMessageBox}( \textcolor{keyword}{this}, \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}(
      )->lastError() );
00849     \}
00850 
00851     \textcolor{comment}{/* If we are, in fact, dealing with a new element, we also want the "new"
       element's associated attributes}
00852 \textcolor{comment}{      to be updated with the known values of these attributes. */}
00853     \textcolor{keywordflow}{foreach}( QString attribute, attributes )
00854     \{
00855       QStringList attributeValues = \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->
      \hyperlink{class_g_c_data_base_interface_a329e17f6c02c62fd554884f2b5a7e2df}{attributeValues}( oldName, attribute );
00856 
00857       \textcolor{keywordflow}{if}( !\hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->updateAttributeValues( newName, 
      attribute, attributeValues ) )
00858       \{
00859         \hyperlink{namespace_g_c_message_space_ab118b3a133686167617eb955029fd44e}{GCMessageSpace::showErrorMessageBox}( \textcolor{keyword}{this}, \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}
      ()->lastError() );
00860       \}
00861     \}
00862 
00863     emitGcCurrentItemChanged( m\_activeItem, 0 );
00864   \}
00865 \}
00866 
00867 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00868 
00869 \textcolor{keywordtype}{void} GCDomTreeWidget::removeItem()
00870 \{
00871   \textcolor{keywordflow}{if}( m\_activeItem )
00872   \{
00873     m\_itemBeingManipulated = \textcolor{keyword}{true};
00874 
00875     \textcolor{comment}{/* I think it is safe to assume that comment nodes will exist just above an
       element}
00876 \textcolor{comment}{      although it might not always be the case that a multi-line comment exists
       within}
00877 \textcolor{comment}{      a single set of comment tags.  However, for those cases, it's the user's
       responsibility}
00878 \textcolor{comment}{      to clean them up. */}
00879     \textcolor{keywordflow}{if}( !m\_commentNode.isNull() )
00880     \{
00881       \textcolor{comment}{/* Check if the comment is an actual comment or if it's valid XML that's
       been}
00882 \textcolor{comment}{        commented out (we don't want to remove snippets). */}
00883       QDomDocument doc;
00884 
00885       \textcolor{keywordflow}{if}( !doc.setContent( m\_commentNode.nodeValue() ) )
00886       \{
00887         m\_comments.removeAll( m\_commentNode );
00888         m\_commentNode.parentNode().removeChild( m\_commentNode );
00889       \}
00890     \}
00891 
00892     \textcolor{comment}{/* Remove the element from the DOM first. */}
00893     QDomNode parentNode = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().parentNode();
00894     parentNode.removeChild( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00895 
00896     \textcolor{comment}{/* Now whack it. */}
00897     \textcolor{keywordflow}{if}( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}() )
00898     \{
00899       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *parentItem = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00900       parentItem->removeChild( m\_activeItem );
00901     \}
00902     \textcolor{keywordflow}{else}
00903     \{
00904       invisibleRootItem()->removeChild( m\_activeItem );
00905     \}
00906 
00907     removeFromList( m\_activeItem );
00908     m\_isEmpty = m\_items.isEmpty();
00909 
00910     \textcolor{keyword}{delete} m\_activeItem;
00911     m\_activeItem = \hyperlink{class_g_c_dom_tree_widget_a70d6a155777d375f3923c2d66e702d15}{gcCurrentItem}();
00912 
00913     updateIndices();
00914     emitGcCurrentItemChanged( m\_activeItem, 0 );
00915     m\_itemBeingManipulated = \textcolor{keyword}{false};
00916   \}
00917 \}
00918 
00919 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00920 
00921 \textcolor{keywordtype}{void} GCDomTreeWidget::stepUp()
00922 \{
00923   \textcolor{keywordflow}{if}( m\_activeItem )
00924   \{
00925     m\_itemBeingManipulated = \textcolor{keyword}{true};
00926 
00927     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* parentItem = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00928 
00929     \textcolor{keywordflow}{if}( parentItem )
00930     \{
00931       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* grandParent = parentItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00932 
00933       \textcolor{keywordflow}{if}( grandParent )
00934       \{
00935         parentItem->removeChild( m\_activeItem );
00936         grandParent->insertChild( grandParent->indexOfChild( parentItem ), 
      m\_activeItem );
00937         grandParent->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().insertBefore( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}(), 
      parentItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}() );
00938 
00939         \textcolor{comment}{/* Update the database to reflect the re-parenting. */}
00940         \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_a91a60134bfb21a3f49d826340bebb852}{updateElementChildren}( grandParent->
      \hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}(), QStringList( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}() ) );
00941       \}
00942 
00943       updateIndices();
00944       emitGcCurrentItemChanged( m\_activeItem, 0 );
00945     \}
00946 
00947     m\_itemBeingManipulated = \textcolor{keyword}{false};
00948   \}
00949 \}
00950 
00951 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00952 
00953 \textcolor{keywordtype}{void} GCDomTreeWidget::stepDown()
00954 \{
00955   \textcolor{keywordflow}{if}( m\_activeItem )
00956   \{
00957     m\_itemBeingManipulated = \textcolor{keyword}{true};
00958 
00959     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* parentItem = m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a1125dbc55a8ba3e50662b8258cb35fdf}{gcParent}();
00960     \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* siblingItem = gcItemFromNode( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().
      previousSiblingElement() );
00961 
00962     \textcolor{comment}{/* Try again in the opposite direction. */}
00963     \textcolor{keywordflow}{if}( !siblingItem )
00964     \{
00965       siblingItem = gcItemFromNode( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().nextSiblingElement(
       ) );
00966     \}
00967 
00968     \textcolor{keywordflow}{if}( siblingItem && parentItem )
00969     \{
00970       parentItem->removeChild( m\_activeItem );
00971       siblingItem->insertChild( 0, m\_activeItem );
00972       siblingItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().insertBefore( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}(), siblingItem
      ->\hyperlink{class_g_c_tree_widget_item_a584cad866bdbd94710d31eb77b804d84}{element}().firstChild() );
00973 
00974       \textcolor{comment}{/* Update the database to reflect the re-parenting. */}
00975       \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->\hyperlink{class_g_c_data_base_interface_a91a60134bfb21a3f49d826340bebb852}{updateElementChildren}( siblingItem->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}
      (), QStringList( m\_activeItem->\hyperlink{class_g_c_tree_widget_item_a3af8c66a690cd55986a38b996a375ba4}{name}() ) );
00976 
00977       updateIndices();
00978       emitGcCurrentItemChanged( m\_activeItem, 0 );
00979     \}
00980 
00981     m\_itemBeingManipulated = \textcolor{keyword}{false};
00982   \}
00983 \}
00984 
00985 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00986 
\hypertarget{gcdomtreewidget_8cpp_source_l00987}{}\hyperlink{class_g_c_dom_tree_widget_a3716c84a2a4fadc653cfac157caa215d}{00987} \textcolor{keywordtype}{void} \hyperlink{class_g_c_dom_tree_widget_a3716c84a2a4fadc653cfac157caa215d}{GCDomTreeWidget::clearAndReset}()
00988 \{
00989   clear();
00990   m\_domDoc->clear();
00991   m\_items.clear();
00992   m\_isEmpty = \textcolor{keyword}{true};
00993 \}
00994 
00995 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
\end{DoxyCode}
