\hypertarget{gcsearchform_8cpp_source}{\section{gcsearchform.\-cpp}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Copyright (c) 2012 - 2013 by William Hallatt.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * This file forms part of "XML Mill".}
00004 \textcolor{comment}{ *}
00005 \textcolor{comment}{ * The official website for this project is <http://www.goblincoding.com> and,}
00006 \textcolor{comment}{ * although not compulsory, it would be appreciated if all works of whatever}
00007 \textcolor{comment}{ * nature using this source code (in whole or in part) include a reference to}
00008 \textcolor{comment}{ * this site.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ * Should you wish to contact me for whatever reason, please do so via:}
00011 \textcolor{comment}{ *}
00012 \textcolor{comment}{ *                 <http://www.goblincoding.com/contact>}
00013 \textcolor{comment}{ *}
00014 \textcolor{comment}{ * This program is free software: you can redistribute it and/or modify it
       under}
00015 \textcolor{comment}{ * the terms of the GNU General Public License as published by the Free
       Software}
00016 \textcolor{comment}{ * Foundation, either version 3 of the License, or (at your option) any later}
00017 \textcolor{comment}{ * version.}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ * This program is distributed in the hope that it will be useful, but WITHOUT}
00020 \textcolor{comment}{ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
       FITNESS}
00021 \textcolor{comment}{ * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
       details.}
00022 \textcolor{comment}{ *}
00023 \textcolor{comment}{ * You should have received a copy of the GNU General Public License along with}
00024 \textcolor{comment}{ * this program (GNUGPL.txt).  If not, see}
00025 \textcolor{comment}{ *}
00026 \textcolor{comment}{ *                    <http://www.gnu.org/licenses/>}
00027 \textcolor{comment}{ */}
00028 
00029 \textcolor{preprocessor}{#include "gcsearchform.h"}
00030 \textcolor{preprocessor}{#include "ui\_gcsearchform.h"}
00031 \textcolor{preprocessor}{#include "utils/gctreewidgetitem.h"}
00032 
00033 \textcolor{preprocessor}{#include <QMessageBox>}
00034 
00035 \textcolor{comment}{/*-------------------------------- NON MEMBER FUNCTIONS
       --------------------------------*/}
00036 
00037 \textcolor{keywordtype}{bool} lessThan( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *lhs, \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *rhs )
00038 \{
00039   \textcolor{keywordflow}{return} ( lhs->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() < rhs->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() );
00040 \}
00041 
00042 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00043 
00044 \textcolor{keywordtype}{bool} greaterThan( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *lhs, \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *rhs )
00045 \{
00046   \textcolor{keywordflow}{return} ( lhs->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() > rhs->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() );
00047 \}
00048 
00049 \textcolor{comment}{/*---------------------------------- MEMBER FUNCTIONS
       ----------------------------------*/}
00050 
\hypertarget{gcsearchform_8cpp_source_l00051}{}\hyperlink{class_g_c_search_form_a3e8731704cbe2cc86957af8aa6d7c17a}{00051} \hyperlink{class_g_c_search_form_a3e8731704cbe2cc86957af8aa6d7c17a}{GCSearchForm::GCSearchForm}( \textcolor{keyword}{const} QList< GCTreeWidgetItem * > &items, \textcolor{keyword}{const} 
      QString &docContents, QWidget *parent ) :
00052   QDialog        ( parent ),
00053   ui             ( new Ui::\hyperlink{class_g_c_search_form}{GCSearchForm} ),
00054   m\_text         (),
00055   m\_wasFound     ( false ),
00056   m\_searchUp     ( false ),
00057   m\_firstRun     ( true ),
00058   m\_previousIndex( -1 ),
00059   m\_searchFlags  ( 0 ),
00060   m\_items        ( items )
00061 \{
00062   ui->setupUi( \textcolor{keyword}{this} );
00063   ui->lineEdit->setFocus();
00064   m\_text.setText( docContents );
00065 
00066   connect( ui->searchButton, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( search() ) );
00067   connect( ui->closeButton,  SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( close() ) );
00068 
00069   connect( ui->caseSensitiveCheckBox, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( 
      caseSensitive() ) );
00070   connect( ui->wholeWordsCheckBox,    SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( 
      wholeWords() ) );
00071   connect( ui->searchUpCheckBox,      SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( searchUp
      () ) );
00072 
00073   setAttribute( Qt::WA\_DeleteOnClose );
00074 \}
00075 
00076 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00077 
\hypertarget{gcsearchform_8cpp_source_l00078}{}\hyperlink{class_g_c_search_form_a27023a33b05baafe5d41cfb738985688}{00078} \hyperlink{class_g_c_search_form_a27023a33b05baafe5d41cfb738985688}{GCSearchForm::~GCSearchForm}()
00079 \{
00080   \textcolor{comment}{/* The QDomDocument m\_doc points at is owned externally. */}
00081   \textcolor{keyword}{delete} ui;
00082 \}
00083 
00084 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00085 
00086 \textcolor{keywordtype}{void} GCSearchForm::search()
00087 \{
00088   m\_firstRun = \textcolor{keyword}{false};
00089   QString searchText = ui->lineEdit->text();
00090   \textcolor{keywordtype}{bool} found = m\_text.find( searchText, m\_searchFlags );
00091 
00092   \textcolor{comment}{/* The first time we enter this function, if the text does not exist}
00093 \textcolor{comment}{    within the document, "found" and "m\_wasFound" will both be false.}
00094 \textcolor{comment}{    However, if the text does exist, we wish to know that we found a match}
00095 \textcolor{comment}{    at least once so that, when we reach the end of the document and "found"}
00096 \textcolor{comment}{    is once more false, we can reset all indices and flags in order to start}
00097 \textcolor{comment}{    again from the beginning. */}
00098   \textcolor{keywordflow}{if}( ( ( found != m\_wasFound ) && m\_wasFound ) ||
00099       ( !m\_wasFound && m\_searchUp ) )
00100   \{
00101     resetCursor();
00102     found = m\_text.find( searchText, m\_searchFlags );
00103   \}
00104 
00105   \textcolor{keywordflow}{if}( found )
00106   \{
00107     m\_wasFound = \textcolor{keyword}{true};
00108 
00109     \textcolor{comment}{/* Highlight the entire node (element, attributes and attribute values) }
00110 \textcolor{comment}{      in which the match was found. */}
00111     m\_text.moveCursor( QTextCursor::StartOfLine );
00112     m\_text.moveCursor( QTextCursor::EndOfLine, QTextCursor::KeepAnchor );
00113 
00114     QString nodeText = m\_text.textCursor().selectedText().trimmed();
00115     QList< GCTreeWidgetItem* > matchingItems;
00116 
00117     \textcolor{comment}{/* Find the first tree widget item whose corresponding element node matches
       the}
00118 \textcolor{comment}{      highlighted text. */}
00119     \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < m\_items.size(); ++i )
00120     \{
00121       \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem}* treeItem = m\_items.at( i );
00122 
00123       \textcolor{keywordflow}{if}( m\_items.at( i )->toString() == nodeText )
00124       \{
00125         matchingItems.append( treeItem );
00126       \}
00127     \}
00128 
00129     \textcolor{keywordflow}{if}( !m\_searchUp )
00130     \{
00131       \textcolor{comment}{/* Sort ascending. */}
00132       qSort( matchingItems.begin(), matchingItems.end(), lessThan );
00133 
00134       \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < matchingItems.size(); ++i )
00135       \{
00136         \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *treeItem = matchingItems.at( i );
00137 
00138         \textcolor{comment}{/* Make sure we find the next occurrence of the match ("down" from the}
00139 \textcolor{comment}{          previous match). */}
00140         \textcolor{keywordflow}{if}( treeItem->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() > m\_previousIndex )
00141         \{
00142           m\_previousIndex = treeItem->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}();
00143           emit foundMatch( treeItem );
00144           \textcolor{keywordflow}{break};
00145         \}
00146       \}
00147     \}
00148     \textcolor{keywordflow}{else}
00149     \{
00150       \textcolor{comment}{/* Sort descending. */}
00151       qSort( matchingItems.begin(), matchingItems.end(), greaterThan );
00152 
00153       \textcolor{keywordflow}{for}( \textcolor{keywordtype}{int} i = 0; i < matchingItems.size(); ++i )
00154       \{
00155         \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *treeItem = matchingItems.at( i );
00156 
00157         \textcolor{comment}{/* Make sure we find the next occurrence of the match ("up" from the}
00158 \textcolor{comment}{          previous match). */}
00159         \textcolor{keywordflow}{if}( treeItem->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}() < m\_previousIndex )
00160         \{
00161           m\_previousIndex = treeItem->\hyperlink{class_g_c_tree_widget_item_af6b48ae274cc4989811ef44944c8ad76}{index}();
00162           emit foundMatch( treeItem );
00163           \textcolor{keywordflow}{break};
00164         \}
00165       \}
00166     \}
00167   \}
00168   \textcolor{keywordflow}{else}
00169   \{
00170     QMessageBox::information( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Not Found"}, QString( \textcolor{stringliteral}{"Can't find the text:
      \(\backslash\)"%1\(\backslash\)""} ).arg( searchText ) );
00171   \}
00172 \}
00173 
00174 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00175 
00176 \textcolor{keywordtype}{void} GCSearchForm::resetCursor()
00177 \{
00178   \textcolor{comment}{/* Reset cursor so that we may keep cycling through the document content. */}
00179   \textcolor{keywordflow}{if}( ui->searchUpCheckBox->isChecked() )
00180   \{
00181     m\_text.moveCursor( QTextCursor::End );
00182     QMessageBox::information( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Reached Top"}, \textcolor{stringliteral}{"Search reached top,
       continuing at bottom."} );
00183     m\_previousIndex = 9999999;
00184   \}
00185   \textcolor{keywordflow}{else}
00186   \{
00187     m\_text.moveCursor( QTextCursor::Start );
00188     QMessageBox::information( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Reached Bottom"}, \textcolor{stringliteral}{"Search reached bottom,
       continuing at top."} );
00189     m\_previousIndex = -1;
00190   \}
00191 \}
00192 
00193 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00194 
00195 \textcolor{keywordtype}{void} GCSearchForm::searchUp()
00196 \{
00197   \textcolor{comment}{/* If the user ticks the "Search Up" box before anything else, we need to set
       the}
00198 \textcolor{comment}{    previous index to a large value to ensure we start at the very bottom. */}
00199   \textcolor{keywordflow}{if}( m\_firstRun )
00200   \{
00201     m\_previousIndex = 9999999;
00202   \}
00203 
00204   \textcolor{keywordflow}{if}( ui->searchUpCheckBox->isChecked() )
00205   \{
00206     m\_searchFlags |= QTextDocument::FindBackward;
00207     m\_searchUp = \textcolor{keyword}{true};
00208   \}
00209   \textcolor{keywordflow}{else}
00210   \{
00211     m\_searchFlags ^= QTextDocument::FindBackward;
00212     m\_searchUp = \textcolor{keyword}{false};
00213   \}
00214 \}
00215 
00216 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00217 
00218 \textcolor{keywordtype}{void} GCSearchForm::caseSensitive()
00219 \{
00220   \textcolor{comment}{/* Reset found flag every time the user changes the search options. */}
00221   m\_wasFound = \textcolor{keyword}{false};
00222 
00223   \textcolor{keywordflow}{if}( ui->caseSensitiveCheckBox->isChecked() )
00224   \{
00225     m\_searchFlags |= QTextDocument::FindCaseSensitively;
00226   \}
00227   \textcolor{keywordflow}{else}
00228   \{
00229     m\_searchFlags ^= QTextDocument::FindCaseSensitively;
00230   \}
00231 \}
00232 
00233 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00234 
00235 \textcolor{keywordtype}{void} GCSearchForm::wholeWords()
00236 \{
00237   \textcolor{comment}{/* Reset found flag every time the user changes the search options. */}
00238   m\_wasFound = \textcolor{keyword}{false};
00239 
00240   \textcolor{keywordflow}{if}( ui->wholeWordsCheckBox->isChecked() )
00241   \{
00242     m\_searchFlags |= QTextDocument::FindWholeWords;
00243   \}
00244   \textcolor{keywordflow}{else}
00245   \{
00246     m\_searchFlags ^= QTextDocument::FindWholeWords;
00247   \}
00248 \}
00249 
00250 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00251 
00252 \textcolor{keywordtype}{void} GCSearchForm::foundMatch( \hyperlink{class_g_c_tree_widget_item}{GCTreeWidgetItem} *treeItem )
00253 \{
00254   emit \hyperlink{class_g_c_search_form_a275c8071b3e054236f90d979da26d084}{foundItem}( treeItem );
00255 
00256   \textcolor{keywordflow}{if}( ui->searchButton->text() == \textcolor{stringliteral}{"Search"} )
00257   \{
00258     ui->searchButton->setText( \textcolor{stringliteral}{"Next"} );
00259   \}
00260 \}
00261 
00262 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
\end{DoxyCode}
