\hypertarget{gcrestorefilesform_8cpp_source}{\section{gcrestorefilesform.\-cpp}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/* Copyright (c) 2012 - 2013 by William Hallatt.}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * This file forms part of "XML Mill".}
00004 \textcolor{comment}{ *}
00005 \textcolor{comment}{ * The official website for this project is <http://www.goblincoding.com> and,}
00006 \textcolor{comment}{ * although not compulsory, it would be appreciated if all works of whatever}
00007 \textcolor{comment}{ * nature using this source code (in whole or in part) include a reference to}
00008 \textcolor{comment}{ * this site.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ * Should you wish to contact me for whatever reason, please do so via:}
00011 \textcolor{comment}{ *}
00012 \textcolor{comment}{ *                 <http://www.goblincoding.com/contact>}
00013 \textcolor{comment}{ *}
00014 \textcolor{comment}{ * This program is free software: you can redistribute it and/or modify it
       under}
00015 \textcolor{comment}{ * the terms of the GNU General Public License as published by the Free
       Software}
00016 \textcolor{comment}{ * Foundation, either version 3 of the License, or (at your option) any later}
00017 \textcolor{comment}{ * version.}
00018 \textcolor{comment}{ *}
00019 \textcolor{comment}{ * This program is distributed in the hope that it will be useful, but WITHOUT}
00020 \textcolor{comment}{ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
       FITNESS}
00021 \textcolor{comment}{ * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
       details.}
00022 \textcolor{comment}{ *}
00023 \textcolor{comment}{ * You should have received a copy of the GNU General Public License along with}
00024 \textcolor{comment}{ * this program (GNUGPL.txt).  If not, see}
00025 \textcolor{comment}{ *}
00026 \textcolor{comment}{ *                    <http://www.gnu.org/licenses/>}
00027 \textcolor{comment}{ */}
00028 
00029 \textcolor{preprocessor}{#include "gcrestorefilesform.h"}
00030 \textcolor{preprocessor}{#include "ui\_gcrestorefilesform.h"}
00031 \textcolor{preprocessor}{#include "xml/xmlsyntaxhighlighter.h"}
00032 \textcolor{preprocessor}{#include "db/gcdatabaseinterface.h"}
00033 \textcolor{preprocessor}{#include "utils/gcglobalspace.h"}
00034 \textcolor{preprocessor}{#include "utils/gcmessagespace.h"}
00035 
00036 \textcolor{preprocessor}{#include <QFile>}
00037 \textcolor{preprocessor}{#include <QDomDocument>}
00038 \textcolor{preprocessor}{#include <QTextStream>}
00039 \textcolor{preprocessor}{#include <QFileDialog>}
00040 
00041 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00042 
\hypertarget{gcrestorefilesform_8cpp_source_l00043}{}\hyperlink{class_g_c_restore_files_form_a0b736b8d4da5adb072e32ea188526634}{00043} \hyperlink{class_g_c_restore_files_form_a0b736b8d4da5adb072e32ea188526634}{GCRestoreFilesForm::GCRestoreFilesForm}( \textcolor{keyword}{const} QStringList &tempFiles, QWidget *
      parent ) :
00044   QDialog    ( parent ),
00045   ui         ( new Ui::\hyperlink{class_g_c_restore_files_form}{GCRestoreFilesForm} ),
00046   m\_tempFiles( tempFiles ),
00047   m\_fileName ( \textcolor{stringliteral}{""} )
00048 \{
00049   ui->setupUi( \textcolor{keyword}{this} );
00050   ui->plainTextEdit->setFont( QFont( \hyperlink{namespace_g_c_global_space_a9d7158c8a1dfcc867d85ee6b9c5c4810}{GCGlobalSpace::FONT}, 
      \hyperlink{namespace_g_c_global_space_ab9fa2f10bab070a4f59b7e3ef9166c86}{GCGlobalSpace::FONTSIZE} ) );
00051   setAttribute( Qt::WA\_DeleteOnClose );
00052 
00053   connect( ui->saveButton, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( saveFile() ) );
00054   connect( ui->nextButton, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( next() ) );
00055   connect( ui->cancelButton, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( close() ) );
00056   connect( ui->discardButton, SIGNAL( clicked() ), \textcolor{keyword}{this}, SLOT( deleteTempFile()
       ) );
00057 
00058   \textcolor{comment}{/* Everything happens automagically and the text edit takes ownership. */}
00059   \hyperlink{class_xml_syntax_highlighter}{XmlSyntaxHighlighter} *highLighter = \textcolor{keyword}{new} \hyperlink{class_xml_syntax_highlighter}{XmlSyntaxHighlighter}( ui->
      plainTextEdit->document() );
00060   Q\_UNUSED( highLighter );
00061 
00062   next();
00063 \}
00064 
00065 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00066 
\hypertarget{gcrestorefilesform_8cpp_source_l00067}{}\hyperlink{class_g_c_restore_files_form_a69ec217c50d53d5cb0cfbf7b7da56936}{00067} \hyperlink{class_g_c_restore_files_form_a69ec217c50d53d5cb0cfbf7b7da56936}{GCRestoreFilesForm::~GCRestoreFilesForm}()
00068 \{
00069   \textcolor{keyword}{delete} ui;
00070 \}
00071 
00072 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00073 
00074 \textcolor{keywordtype}{void} GCRestoreFilesForm::saveFile()
00075 \{
00076   QString fileName = QFileDialog::getSaveFileName( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Save As"}, 
      QDir::homePath(), \textcolor{stringliteral}{"XML Files (*.*)"} );
00077 
00078   \textcolor{comment}{/* If the user clicked "OK". */}
00079   \textcolor{keywordflow}{if}( !fileName.isEmpty() )
00080   \{
00081     QFile file( fileName );
00082 
00083     \textcolor{keywordflow}{if}( !file.open( QIODevice::ReadWrite | QIODevice::Truncate | 
      QIODevice::Text ) )
00084     \{
00085       QString errMsg = QString( \textcolor{stringliteral}{"Failed to save file \(\backslash\)"%1\(\backslash\)": [%2]."} )
00086                        .arg( fileName )
00087                        .arg( file.errorString() );
00088       \hyperlink{namespace_g_c_message_space_ab118b3a133686167617eb955029fd44e}{GCMessageSpace::showErrorMessageBox}( \textcolor{keyword}{this}, errMsg );
00089     \}
00090     \textcolor{keywordflow}{else}
00091     \{
00092       QTextStream outStream( &file );
00093       outStream << ui->plainTextEdit->toPlainText();
00094       file.close();
00095 
00096       deleteTempFile();
00097     \}
00098   \}
00099 \}
00100 
00101 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00102 
00103 \textcolor{keywordtype}{void} GCRestoreFilesForm::deleteTempFile()\textcolor{keyword}{ const}
00104 \textcolor{keyword}{}\{
00105   QDir dir;
00106   dir.remove( m\_fileName );
00107   ui->plainTextEdit->clear();
00108   ui->lineEdit->clear();
00109 \}
00110 
00111 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00112 
00113 \textcolor{keywordtype}{void} GCRestoreFilesForm::next()
00114 \{
00115   \textcolor{keywordflow}{if}( !m\_tempFiles.isEmpty() )
00116   \{
00117     m\_fileName = m\_tempFiles.takeFirst();
00118     ui->nextButton->setEnabled( \textcolor{keyword}{true} );
00119     loadFile( m\_fileName );
00120   \}
00121   \textcolor{keywordflow}{else}
00122   \{
00123     ui->plainTextEdit->setPlainText( \textcolor{stringliteral}{"No documents left to recover."} );
00124     ui->saveButton->setVisible( \textcolor{keyword}{false} );
00125     ui->discardButton->setVisible( \textcolor{keyword}{false} );
00126     ui->nextButton->setVisible( \textcolor{keyword}{false} );
00127     ui->cancelButton->setText( \textcolor{stringliteral}{"Close"} );
00128     ui->lineEdit->clear();
00129   \}
00130 \}
00131 
00132 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
00133 
00134 \textcolor{keywordtype}{void} GCRestoreFilesForm::loadFile( \textcolor{keyword}{const} QString &fileName )
00135 \{
00136   QFile file( fileName );
00137 
00138   \textcolor{keywordflow}{if}( file.open( QIODevice::ReadOnly | QIODevice::Text ) )
00139   \{
00140     QString displayName = fileName;
00141     displayName = displayName.remove( QString( \textcolor{stringliteral}{"\_%1\_temp"} ).arg( 
      \hyperlink{class_g_c_data_base_interface_a1baea9c0667aa8b610ec30076fcab84c}{GCDataBaseInterface::instance}()->activeSessionName() ).\textcolor{keyword}{remove}( \textcolor{stringliteral}{".db"} ) );
00142     ui->lineEdit->setText( displayName );
00143 
00144     QString xmlErr( \textcolor{stringliteral}{""} );
00145     \textcolor{keywordtype}{int}     line  ( -1 );
00146     \textcolor{keywordtype}{int}     col   ( -1 );
00147 
00148     QTextStream inStream( &file );
00149     QString fileContent = inStream.readAll();
00150     ui->plainTextEdit->setPlainText( fileContent );
00151 
00152     QDomDocument doc;
00153 
00154     \textcolor{keywordflow}{if}( !doc.setContent( fileContent, &xmlErr, &line, &col ) )
00155     \{
00156       QString errorMsg = QString( \textcolor{stringliteral}{"XML is broken - Error [%1], line [%2],
       column [%3]."} )
00157                          .arg( xmlErr )
00158                          .arg( line )
00159                          .arg( col );
00160 
00161       \hyperlink{namespace_g_c_message_space_ab118b3a133686167617eb955029fd44e}{GCMessageSpace::showErrorMessageBox}( \textcolor{keyword}{this}, errorMsg );
00162 
00163       \textcolor{comment}{/* Unfortunately the line number returned by the DOM doc doesn't match up
       with what's}
00164 \textcolor{comment}{        visible in the QTextEdit.  It seems as if it's mostly off by two lines.
        For now it's a}
00165 \textcolor{comment}{        fix, but will have to figure out how to make sure that we highlight the
       correct lines.}
00166 \textcolor{comment}{        Ultimately this finds the broken XML and highlights it in red...what a
       mission... */}
00167       QTextBlock textBlock = ui->plainTextEdit->document()->
      findBlockByLineNumber( line - 2 );
00168       QTextCursor cursor( textBlock );
00169       cursor.movePosition( QTextCursor::NextWord );
00170       cursor.movePosition( QTextCursor::EndOfBlock, QTextCursor::KeepAnchor );
00171 
00172       QTextEdit::ExtraSelection highlight;
00173       highlight.cursor = cursor;
00174       highlight.format.setBackground( QColor( 220, 150, 220 ) );
00175       highlight.format.setProperty  ( QTextFormat::FullWidthSelection, \textcolor{keyword}{true} );
00176 
00177       QList< QTextEdit::ExtraSelection > extras;
00178       extras << highlight;
00179       ui->plainTextEdit->setExtraSelections( extras );
00180       ui->plainTextEdit->ensureCursorVisible();
00181     \}
00182   \}
00183   \textcolor{keywordflow}{else}
00184   \{
00185     \hyperlink{namespace_g_c_message_space_ab118b3a133686167617eb955029fd44e}{GCMessageSpace::showErrorMessageBox}( \textcolor{keyword}{this}, \textcolor{stringliteral}{"Failed to open file. Cannot
       recover."} );
00186   \}
00187 \}
00188 
00189 \textcolor{comment}{/*
      --------------------------------------------------------------------------------------*/}
\end{DoxyCode}
